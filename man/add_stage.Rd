% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/stage.R
\name{add_stage}
\alias{add_stage}
\title{Define a New Stage in Multi-Stage Designs}
\usage{
add_stage(.data, label = NULL)
}
\arguments{
\item{.data}{A \code{sampling_design} object.}

\item{label}{Optional character string labeling the stage (e.g., "Schools",
"Classrooms", "Students"). Used for documentation and printing.}
}
\value{
A modified \code{sampling_design} object with a new stage context.
}
\description{
\code{add_stage()} opens a new stage context in multi-stage sampling designs.
It acts as a delimiter between stages, not a wrapper -- each stage's
specification follows \code{add_stage()} using the same verbs.
}
\details{
\subsection{Multi-Stage Design Structure}{

In multi-stage designs, sampling proceeds hierarchically:
\enumerate{
\item \strong{Stage 1}: Select primary sampling units (PSUs), e.g., schools
\item \strong{Stage 2}: Within selected PSUs, select secondary units, e.g., classrooms
\item \strong{Stage 3+}: Continue nesting as needed
}

Each stage can have its own:
\itemize{
\item Stratification (\code{\link[=stratify_by]{stratify_by()}})
\item Clustering (\code{\link[=cluster_by]{cluster_by()}})
\item Selection method and sample size (\code{\link[=draw]{draw()}})
}
}

\subsection{Design Patterns}{

\strong{Pattern 1: Single-stage (no explicit \code{add_stage()}):}
\preformatted{
sampling_design() |>
  stratify_by(...) |>
  draw(...)
}

\strong{Pattern 2: Multi-stage (explicit stages):}
\preformatted{
sampling_design() |>
  add_stage(label = "Stage 1") |>
    cluster_by(...) |>
    draw(...) |>
  add_stage(label = "Stage 2") |>
    cluster_by(...) |>
    draw(...) |>
  add_stage(label = "Stage 3") |>
    draw(...)
}
}

\subsection{Validation Rules}{
\itemize{
\item Each stage must end with \code{\link[=draw]{draw()}} before the next \code{add_stage()} or \code{\link[=execute]{execute()}}
\item Empty stages (stage followed immediately by stage) are not allowed
\item The final stage doesn't need \code{cluster_by()} (samples individuals)
}
}
}
\section{Execution}{

Multi-stage designs can be executed:
\itemize{
\item All at once with a single frame (hierarchical data)
\item All at once with multiple frames (one per stage)
\item Stage by stage using \verb{stages =} parameter in \code{\link[=execute]{execute()}}
}

See \code{\link[=execute]{execute()}} for details on execution patterns.
}

\examples{
# Two-stage design: districts then EAs
zwe_frame <- zwe_eas |>
  dplyr::mutate(district_hh = sum(households), .by = district)

sampling_design() |>
  add_stage(label = "Districts") |>
    cluster_by(district) |>
    draw(n = 20, method = "pps_brewer", mos = district_hh) |>
  add_stage(label = "EAs") |>
    draw(n = 10) |>
  execute(zwe_frame, seed = 123)

# Two-stage with stratification at stage 1
sampling_design() |>
  add_stage(label = "Districts") |>
    stratify_by(province) |>
    cluster_by(district) |>
    draw(n = 2, method = "pps_brewer", mos = district_hh) |>
  add_stage(label = "EAs") |>
    draw(n = 5) |>
  execute(zwe_frame, seed = 1234)

# DHS-style two-stage stratified cluster sample
sampling_design(title = "DHS-style Household Survey") |>
  add_stage(label = "Enumeration Areas") |>
    stratify_by(region, urban_rural) |>
    cluster_by(ea_id) |>
    draw(n = 3, method = "pps_brewer", mos = households) |>
  add_stage(label = "Households") |>
    draw(n = 20) |>
  execute(bfa_eas, seed = 2026)

# Partial execution: select only stage 1
design <- sampling_design() |>
  add_stage(label = "EAs") |>
    stratify_by(region) |>
    cluster_by(ea_id) |>
    draw(n = 10, method = "pps_brewer", mos = households) |>
  add_stage(label = "Households") |>
    draw(n = 12)

# Execute stage 1 only
selected_eas <- execute(design, bfa_eas, stages = 1, seed = 1)
nrow(selected_eas)

}
\seealso{
\code{\link[=sampling_design]{sampling_design()}} for creating designs,
\code{\link[=draw]{draw()}} for completing stages,
\code{\link[=execute]{execute()}} for running multi-stage designs
}
