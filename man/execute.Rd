% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/execute.R
\name{execute}
\alias{execute}
\title{Execute a Sampling Design}
\usage{
execute(.data, ..., stages = NULL, seed = NULL)
}
\arguments{
\item{.data}{A \code{sampling_design} object, or a \code{tbl_sample} object
for continuation (multi-phase or multi-stage with separate frames).}

\item{...}{Data frame(s) to sample from. For single-stage designs, provide
one frame. For multi-stage designs with separate frames, provide frames
in stage order.}

\item{stages}{Integer vector specifying which stage(s) to execute.
Default (\code{NULL}) executes all remaining stages.}

\item{seed}{Integer random seed for reproducibility.}
}
\value{
A \code{tbl_sample} object (a data frame subclass with sampling
metadata). Contains the selected units plus:
\itemize{
\item \code{.sample_id}: Unique identifier for each sampled unit
\item \code{.weight}: Sampling weight (1/probability)
\item \code{.weight_1}, \code{.weight_2}, ...: Per-stage sampling weights
\item \code{.fpc_1}, \code{.fpc_2}, ...: Per-stage population sizes (finite
population correction). For stratified stages, this is the stratum
population size N_h; for clustered stages, the number of clusters.
\item \code{.draw_1}, \code{.draw_2}, ...: Draw index per stage (WR/PMR methods only).
Each row represents one independent draw; the draw index identifies
which with-replacement selection the row came from.
\item \code{.certainty_1}, \code{.certainty_2}, ...: Whether each unit was a certainty
selection (PPS methods with certainty thresholds only)
\item Stage and stratum identifiers as appropriate
}
}
\description{
\code{execute()} runs a sampling design against one or more data frames,
producing a sampled dataset with appropriate weights and metadata.
}
\details{
\subsection{Execution Patterns}{
\subsection{Single-Stage Execution}{

\preformatted{
design |> execute(frame, seed = 1)
}
}

\subsection{Multi-Stage with Single Frame}{

For hierarchical data where all stages are in one frame:
\preformatted{
design |> execute(frame, seed = 2025)
}
The frame must contain all clustering variables and respect nesting.
}

\subsection{Multi-Stage with Multiple Frames}{

When each stage has its own frame:
\preformatted{
design |> execute(frame1, frame2, frame3, seed = 424)
}
Frames are matched to stages by position.
}

\subsection{Partial Execution (Operational Sampling)}{

Execute only specific stages:
\preformatted{
selected_eas <- design |> execute(ea_frame, stages = 1, seed = 42)
# ... fieldwork: listing in selected EAs ...
sample <- selected_eas |> execute(listing_frame, seed = 43)
}
}

\subsection{Multi-Phase (Continuation)}{

When \code{.data} is a \code{tbl_sample}, sampling continues from that sample:
\preformatted{
phase1 <- design1 |> execute(frame, seed = 42)
# ... add screening data to phase1 ...
phase2 <- design2 |> execute(phase1_updated, seed = 123)
}
Weights compound automatically in multi-phase designs.
}

}

\subsection{Weight Calculation}{

Weights are calculated as the inverse of inclusion probabilities:
\itemize{
\item \strong{SRS}: w = N/n (population size / sample size)
\item \strong{Stratified}: w_h = N_h/n_h within each stratum
\item \strong{PPS}: \eqn{w_i = 1/\pi_i}{w_i = 1/pi_i} where \eqn{\pi_i}{pi_i} is the inclusion probability
\item \strong{Multi-stage}: Weights compound across stages
\item \strong{Multi-phase}: Weights compound across phases
}
}
}
\examples{
# Basic SRS execution
sample <- sampling_design() |>
  draw(n = 100) |>
  execute(kenya_health, seed = 1234)
sample

# Stratified execution with proportional allocation
sample <- sampling_design() |>
  stratify_by(facility_type, alloc = "proportional") |>
  draw(n = 300) |>
  execute(kenya_health, seed = 5789)
table(sample$facility_type)

# Two-stage cluster sample execution
sample <- sampling_design() |>
  add_stage(label = "Schools") |>
    cluster_by(school_id) |>
    draw(n = 30, method = "pps_brewer", mos = enrollment) |>
  add_stage(label = "Students") |>
    draw(n = 15) |>
  execute(tanzania_schools, seed = 3)
length(unique(sample$school_id))  # 30 schools selected

# Partial execution: stage 1 only
design <- sampling_design() |>
  add_stage(label = "EAs") |>
    stratify_by(region) |>
    cluster_by(ea_id) |>
    draw(n = 5, method = "pps_brewer", mos = hh_count) |>
  add_stage(label = "Households") |>
    draw(n = 12)

# Execute only stage 1 to get selected EAs
selected_eas <- execute(design, niger_eas, stages = 1, seed = 2)
nrow(selected_eas)  # Number of selected EAs

}
\seealso{
\code{\link[=sampling_design]{sampling_design()}} for creating designs,
\code{\link[=is_tbl_sample]{is_tbl_sample()}} for testing results,
\code{\link[=get_design]{get_design()}} for extracting metadata
}
