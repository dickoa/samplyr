% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/stratify.R
\name{stratify_by}
\alias{stratify_by}
\title{Define Stratification}
\usage{
stratify_by(.data, ..., alloc = NULL, variance = NULL, cost = NULL)
}
\arguments{
\item{.data}{A \code{sampling_design} object (piped from \code{\link[=sampling_design]{sampling_design()}} or
\code{\link[=stage]{stage()}}).}

\item{...}{<\code{\link[dplyr:dplyr_tidy_select]{tidy-select}}> Stratification
variables. These should be categorical variables that define the strata.}

\item{alloc}{Character string specifying the allocation method. One of:
\itemize{
\item \code{NULL} (default): No allocation; \code{n} in \code{\link[=draw]{draw()}} is per stratum
\item \code{"equal"}: Equal allocation across strata
\item \code{"proportional"}: Proportional to stratum size
\item \code{"neyman"}: Neyman optimal allocation (requires \code{variance})
\item \code{"optimal"}: Cost-variance optimal allocation (requires \code{variance} and \code{cost})
}}

\item{variance}{A data frame with stratum variances for Neyman or optimal
allocation. Must contain columns for all stratification variables plus
a \code{var} column with variance estimates.}

\item{cost}{A data frame with stratum costs for optimal allocation.
Must contain columns for all stratification variables plus a \code{cost}
column with per-unit costs.}
}
\value{
A modified \code{sampling_design} object with stratification specified.
}
\description{
\code{stratify_by()} specifies stratification variables and optional allocation
methods for a sampling design. Stratification ensures representation from
all subgroups defined by the stratification variables.
}
\details{
\subsection{Allocation Methods}{

When no \code{alloc} is specified, the \code{n} parameter in \code{\link[=draw]{draw()}} is interpreted
as the sample size \emph{per stratum}. When an \code{alloc} method is specified,
\code{n} becomes the \emph{total} sample size to be distributed according to the
allocation method.
\subsection{Equal Allocation}{

Each stratum receives n/H units, where H is the number of strata.
}

\subsection{Proportional Allocation}{

Each stratum receives n × (N_h/N) units, where N_h is the stratum
population size and N is the total population size.
}

\subsection{Neyman Allocation}{

Minimizes variance for fixed sample size. Each stratum receives:
n × (N_h × S_h) / Σ(N_h × S_h)
where S_h is the stratum standard deviation.
}

\subsection{Optimal Allocation}{

Minimizes variance for fixed cost (or cost for fixed variance).
Each stratum receives:
n × (N_h × S_h / √C_h) / Σ(N_h × S_h / √C_h)
where C_h is the per-unit cost in stratum h.
}

\subsection{Custom Allocation}{

For custom stratum-specific sample sizes or rates, pass a data frame
directly to the \code{n} or \code{frac} argument in \code{\link[=draw]{draw()}}. The data frame must
contain columns for all stratification variables plus an \code{n} or \code{frac} column.
}

}
}
\section{Data Frame Requirements}{

Auxiliary data frames (\code{variance}, \code{cost}) must contain:
\itemize{
\item All stratification variable columns (used as join keys)
\item The appropriate value column (\code{var} or \code{cost})
}
}

\examples{
\dontrun{
# Simple stratification (n per stratum)
sampling_design() |>
  stratify_by(region) |>
  draw(n = 100) |>
  execute(frame, seed = 42)

# Proportional allocation
sampling_design() |>
  stratify_by(region, alloc = "proportional") |>
  draw(n = 1000) |>
  execute(frame, seed = 42)

# Neyman allocation
var_df <- data.frame(
  region = c("North", "South", "East", "West"),
  var = c(15.2, 22.1, 18.5, 20.3)
)
sampling_design() |>
  stratify_by(region, alloc = "neyman", variance = var_df) |>
  draw(n = 1000) |>
  execute(frame, seed = 42)

# Custom sizes (pass data frame to draw)
sizes_df <- data.frame(
  region = c("North", "South", "East", "West"),
  n = c(200, 350, 250, 200)
)
sampling_design() |>
  stratify_by(region) |>
  draw(n = sizes_df) |>
  execute(frame, seed = 42)

# Multiple stratification variables
sampling_design() |>
  stratify_by(region, urban_rural, alloc = "proportional") |>
  draw(n = 2000) |>
  execute(frame, seed = 42)
}

}
\seealso{
\code{\link[=sampling_design]{sampling_design()}} for creating designs,
\code{\link[=draw]{draw()}} for specifying sample sizes,
\code{\link[=cluster_by]{cluster_by()}} for cluster sampling
}
