% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/stratify.R
\name{stratify_by}
\alias{stratify_by}
\title{Define Stratification}
\usage{
stratify_by(.data, ..., alloc = NULL, variance = NULL, cost = NULL)
}
\arguments{
\item{.data}{A \code{sampling_design} object (piped from \code{\link[=sampling_design]{sampling_design()}} or
\code{\link[=stage]{stage()}}).}

\item{...}{<\code{\link[dplyr:dplyr_tidy_select]{tidy-select}}> Stratification
variables. These should be categorical variables that define the strata.}

\item{alloc}{Character string specifying the allocation method. One of:
\itemize{
\item \code{NULL} (default): No allocation; \code{n} in \code{\link[=draw]{draw()}} is per stratum
\item \code{"equal"}: Equal allocation across strata
\item \code{"proportional"}: Proportional to stratum size
\item \code{"neyman"}: Neyman optimal allocation (requires \code{variance})
\item \code{"optimal"}: Cost-variance optimal allocation (requires \code{variance} and \code{cost})
}}

\item{variance}{Stratum variances for Neyman or optimal allocation.
Either a data frame with columns for all stratification variables plus
a \code{var} column, or a named numeric vector (when using a single
stratification variable) where names correspond to stratum levels.}

\item{cost}{Stratum costs for optimal allocation.
Either a data frame with columns for all stratification variables plus
a \code{cost} column, or a named numeric vector (when using a single
stratification variable) where names correspond to stratum levels.}
}
\value{
A modified \code{sampling_design} object with stratification specified.
}
\description{
\code{stratify_by()} specifies stratification variables and optional allocation
methods for a sampling design. Stratification ensures representation from
all subgroups defined by the stratification variables.
}
\details{
\subsection{Allocation Methods}{

When no \code{alloc} is specified, the \code{n} parameter in \code{\link[=draw]{draw()}} is interpreted
as the sample size \emph{per stratum}. When an \code{alloc} method is specified,
\code{n} becomes the \emph{total} sample size to be distributed according to the
allocation method.
\subsection{Equal Allocation}{

Each stratum receives n/H units, where H is the number of strata.
}

\subsection{Proportional Allocation}{

Each stratum receives \eqn{n \times N_h/N}{n * N_h/N} units, where \eqn{N_h} is the stratum
population size and N is the total population size.
}

\subsection{Neyman Allocation}{

Minimizes variance for fixed sample size. Each stratum receives:
\eqn{n \times (N_h \times S_h) / \sum(N_h \times S_h)}{n * (N_h * S_h) / sum(N_h * S_h)}
where S_h is the stratum standard deviation.
}

\subsection{Optimal Allocation}{

Minimizes variance for fixed cost (or cost for fixed variance).
Each stratum receives:
\eqn{n \times (N_h \times S_h / \sqrt{C_h}) / \sum(N_h \times S_h / \sqrt{C_h})}{n * (N_h * S_h / sqrt(C_h)) / sum(N_h * S_h / sqrt(C_h))}
where C_h is the per-unit cost in stratum h.
}

\subsection{Custom Allocation}{

For custom stratum-specific sample sizes or rates, pass a data frame
directly to the \code{n} or \code{frac} argument in \code{\link[=draw]{draw()}}. The data frame must
contain columns for all stratification variables plus an \code{n} or \code{frac} column.
}

}
}
\section{Data Frame Requirements}{

Auxiliary data frames (\code{variance}, \code{cost}) must contain:
\itemize{
\item All stratification variable columns (used as join keys)
\item The appropriate value column (\code{var} or \code{cost})
}
}

\examples{
# Simple stratification: 20 EAs per region
sampling_design() |>
  stratify_by(region) |>
  draw(n = 20) |>
  execute(niger_eas, seed = 1234)

# Proportional allocation across regions
sampling_design() |>
  stratify_by(region, alloc = "proportional") |>
  draw(n = 200) |>
  execute(niger_eas, seed = 123)

# Neyman allocation using pre-computed variances
sampling_design() |>
  stratify_by(region, alloc = "neyman", variance = niger_eas_variance) |>
  draw(n = 200) |>
  execute(niger_eas, seed = 12)

# Optimal allocation considering both variance and cost
sampling_design() |>
  stratify_by(region, alloc = "optimal",
              variance = niger_eas_variance,
              cost = niger_eas_cost) |>
  draw(n = 200) |>
  execute(niger_eas, seed = 1)

# Custom sample sizes per stratum using a data frame
custom_sizes <- data.frame(
  region = c("Agadez", "Diffa", "Dosso", "Maradi",
             "Niamey", "Tahoua", "Tillab\u00e9ri", "Zinder"),
  n = c(15, 20, 30, 35, 25, 30, 25, 20)
)
sampling_design() |>
  stratify_by(region) |>
  draw(n = custom_sizes) |>
  execute(niger_eas, seed = 2026)

# Multiple stratification variables
sampling_design() |>
  stratify_by(region, strata, alloc = "proportional") |>
  draw(n = 300) |>
  execute(niger_eas, seed = 2025)

}
\seealso{
\code{\link[=sampling_design]{sampling_design()}} for creating designs,
\code{\link[=draw]{draw()}} for specifying sample sizes,
\code{\link[=cluster_by]{cluster_by()}} for cluster sampling
}
