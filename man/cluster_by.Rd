% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cluster.R
\name{cluster_by}
\alias{cluster_by}
\title{Define Sampling Units (Clusters)}
\usage{
cluster_by(.data, ...)
}
\arguments{
\item{.data}{A \code{sampling_design} object (piped from \code{\link[=sampling_design]{sampling_design()}},
\code{\link[=stratify_by]{stratify_by()}}, or \code{\link[=add_stage]{add_stage()}}).}

\item{...}{<\code{\link[dplyr:dplyr_tidy_select]{tidy-select}}> Clustering variable(s)
that identify the sampling units. In most cases this is a single variable
(e.g., school_id, household_id).}
}
\value{
A modified \code{sampling_design} object with clustering specified.
}
\description{
\code{cluster_by()} specifies the sampling units (PSUs/clusters) for cluster
or multi-stage sampling designs. Unlike \code{\link[=stratify_by]{stratify_by()}}, which defines
subgroups to sample \emph{within}, \code{cluster_by()} defines units to sample
\emph{as a whole}.
}
\details{
\code{cluster_by()} is purely structural -- it defines \emph{what} to sample, not \emph{how}.
The selection method and sample size are specified in \code{\link[=draw]{draw()}}.
\subsection{Cluster vs. Stratification}{
\itemize{
\item \strong{Stratification} (\code{\link[=stratify_by]{stratify_by()}}): Sample \emph{within} each group; all
groups represented in the sample
\item \strong{Clustering} (\code{cluster_by()}): Sample \emph{groups as units}; only selected
groups appear in sample
}
}

\subsection{Multi-Stage Designs}{

In multi-stage designs, each stage typically has its own clustering variable:
\itemize{
\item Stage 1: Select schools (\code{cluster_by(school_id)})
\item Stage 2: Select classrooms within schools (\code{cluster_by(classroom_id)})
\item Stage 3: Select students within classrooms (no clustering, sample individuals)
}

The nesting structure (classrooms within schools) is validated at execution time.
}
}
\section{Order of Operations}{

In a single stage, the typical order is:
\enumerate{
\item \code{stratify_by()} (optional) - define strata
\item \code{cluster_by()} (optional) - define sampling units
\item \code{draw()} (required) - specify selection parameters
}

Both \code{stratify_by()} and \code{cluster_by()} are optional but \code{draw()} is required.
}

\examples{
# Simple cluster sample: select 30 schools
sampling_design() |>
  cluster_by(school_id) |>
  draw(n = 30) |>
  execute(tanzania_schools, seed = 123)

# Stratified cluster sample: 10 schools per education level
sampling_design() |>
  stratify_by(school_level) |>
  cluster_by(school_id) |>
  draw(n = 10) |>
  execute(tanzania_schools, seed = 1)

# PPS cluster sample using enrollment as measure of size
sampling_design() |>
  cluster_by(school_id) |>
  draw(n = 50, method = "pps_brewer", mos = enrollment) |>
  execute(tanzania_schools, seed = 2026)

# Two-stage cluster sample
sampling_design() |>
  add_stage(label = "Schools") |>
    cluster_by(school_id) |>
    draw(n = 30, method = "pps_brewer", mos = enrollment) |>
  add_stage(label = "Students") |>
    draw(n = 15) |>
  execute(tanzania_schools, seed = 1234)

}
\seealso{
\code{\link[=sampling_design]{sampling_design()}} for creating designs,
\code{\link[=stratify_by]{stratify_by()}} for stratification,
\code{\link[=draw]{draw()}} for specifying selection,
\code{\link[=add_stage]{add_stage()}} for multi-stage designs
}
