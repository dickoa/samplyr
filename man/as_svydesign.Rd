% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/survey.R
\name{as_svydesign}
\alias{as_svydesign}
\alias{as_svydesign.tbl_sample}
\title{Convert a tbl_sample to a survey design object}
\usage{
as_svydesign(x, ...)

\method{as_svydesign}{tbl_sample}(x, ..., nest = TRUE, method = NULL)
}
\arguments{
\item{x}{A \code{tbl_sample} object produced by \code{\link[=execute]{execute()}}.}

\item{...}{Additional arguments passed to \code{\link[survey:svydesign]{survey::svydesign()}}.
In particular, you can pass \code{pps = survey::ppsmat(joint_matrix)}
to supply exact joint inclusion probabilities instead of the
default Brewer approximation (see Details).}

\item{nest}{If \code{TRUE}, relabel cluster ids to enforce nesting within
strata. Passed to \code{\link[survey:svydesign]{survey::svydesign()}}. Default is \code{TRUE}, which
is appropriate for most complex survey designs.}

\item{method}{For two-phase samples, the variance method passed to
\code{\link[survey:twophase]{survey::twophase()}}. One of \code{"full"}, \code{"approx"}, or \code{"simple"}.
This argument is ignored for single-phase samples.}
}
\value{
A \code{survey.design2} object from the survey package.
}
\description{
Creates a \code{\link[survey:svydesign]{survey::svydesign()}} object from a \code{tbl_sample}, using
the sampling design metadata (strata, clusters, weights, and
finite population corrections) captured during \code{\link[=execute]{execute()}}.
}
\details{
The conversion maps samplyr's design specification to the arguments
expected by \code{\link[survey:svydesign]{survey::svydesign()}}:
\itemize{
\item \strong{Cluster ids} (\code{ids}): extracted from \code{cluster_by()} variables at each
stage, assembled into a multi-level formula (e.g., \code{~ ea_id + hh_id}).
For WR/PMR stages, the \code{.draw_k} column is used as the sampling unit
identifier instead (each draw is treated as an independent unit for
Hansen--Hurwitz variance estimation).
\item \strong{Strata} (\code{strata}): extracted from \code{stratify_by()} variables at the
\strong{first executed stage only} (see Multi-stage designs below).
\item \strong{Weights} (\code{weights}): the \code{.weight} column -- the compound weight
across all stages (i.e., the product of per-stage weights
\eqn{w = \prod w_k = \prod 1/\pi_k}{w = prod(1/pi_k)}).
This is the inverse of the overall inclusion probability and is the
correct weight for design-based point estimation
(\eqn{\hat{Y} = \sum w_i y_i}{Y-hat = sum(w_i * y_i)}).
\item \strong{FPC} (\code{fpc}): a per-stage formula assembled from \code{.fpc_k} columns.
The encoding depends on the method:
\itemize{
\item \strong{Equal-probability WOR}: \code{.fpc_k} (the stratum population count
\eqn{N_h}) is passed directly. The survey package derives the sampling
fraction as \eqn{f_h = n_h / N_h}.
\item \strong{PPS WOR}: \code{.fpc_k} is \eqn{N_h}, but this is \strong{not} passed
directly. Instead, a derived column \eqn{1 / w_k = \pi_i}{1/w_k = pi_i}
is created and passed, because \code{survey::svydesign()} interprets FPC
values in \eqn{(0, 1)}{(0,1)} as inclusion probabilities.
\item \strong{WR / PMR}: a synthetic column filled with \code{Inf} is passed. The
survey package interprets this as no finite population correction,
giving Hansen--Hurwitz variance.
}
}
\subsection{Multi-stage designs}{

For multi-stage designs, \code{as_svydesign()} maps each stage's
cluster variable to a level of the \code{ids} formula and provides
per-stage finite population corrections. Strata are exported from
the first stage only, which is consistent with the standard
"with-replacement at stage 1" variance approximation used by
\code{\link[survey:svydesign]{survey::svydesign()}} (Cochran 1977, ch. 11). Under this
approximation, second-stage and deeper stratification affects
weights (which are correctly compounded) but does not need to
appear in the design object for variance estimation -- the
contribution of later stages is captured through the variability
of first-stage unit totals.

Concretely, for a two-stage stratified-cluster design, the exported
call is equivalent to:
\preformatted{
survey::svydesign(
  ids     = ~ ea_id,         # stage-1 clusters
  strata  = ~ region,        # stage-1 strata only
  weights = ~ .weight,       # product of stage-1 and stage-2 weights
  fpc     = ~ .fpc_pi_1 + .fpc_2,  # pi_i for PPS stage, N_h for SRS stage
  data    = sample,
  nest    = TRUE
)
}
}

\subsection{Variance estimation for PPS designs}{

For stages using PPS without replacement methods (\code{pps_brewer},
\code{pps_systematic}, \code{pps_cps}, \code{pps_poisson}, \code{pps_sps}, \code{pps_pareto}), variance is
estimated by default using Brewer's approximation (\code{pps = "brewer"}
in survey's terminology), which approximates the joint inclusion
probabilities from the marginal inclusion probabilities. This is
the approximation described by Berger (2004) and works well for
most PPS designs regardless of the sampling algorithm used.

For exact variance estimation, you can compute joint inclusion
probabilities using \code{\link[=joint_expectation]{joint_expectation()}} and pass them via
\code{pps = survey::ppsmat(joint_matrix)}.
}

\subsection{Chromy's sequential PPS method (PMR)}{

\code{pps_chromy} is classified as a \emph{Probability Minimum Replacement}
(PMR) method -- neither with-replacement nor without-replacement.
Each unit receives exactly \eqn{\lfloor E(n_i) \rfloor} or
\eqn{\lfloor E(n_i) \rfloor + 1} hits, where
\eqn{E(n_i) = n \cdot \textrm{mos}_i / \sum \textrm{mos}}.
When all expected hit counts are below 1, this reduces to WOR;
otherwise large units receive multiple hits.

For variance estimation, Chromy (2009) recommends the
Hansen-Hurwitz (with-replacement) approximation rather than
exact pairwise expectations, which he found "quite variable."
Chauvet (2019) confirmed this in simulation. Accordingly,
\code{as_svydesign()} treats \code{pps_chromy} stages like
with-replacement stages (no FPC, no pps argument).

Note that \code{survey::ppsmat()} is \strong{not} valid for the general
PMR case. The survey package reads \eqn{\pi_i} from the diagonal
of the joint matrix, but for PMR the diagonal contains
\eqn{E(n_i^2)}, which differs from \eqn{E(n_i)} when units
receive multiple hits. The generalized Sen-Yates-Grundy variance
requires \eqn{E(n_i) E(n_j) - E(n_i n_j)} as the pairwise
weight (Chromy 2009, eq. 5), not \eqn{E(n_i^2) E(n_j^2) - E(n_i n_j)}.
}

\subsection{Certainty stratum (take-all units)}{

For PPS without-replacement stages that use certainty selection
(\code{certainty_size} or \code{certainty_prop}), units with inclusion
probability \eqn{\pi_i = 1}{pi_i = 1} are placed in a separate
take-all stratum. This follows the standard practice from
Cochran (1977, ch. 11) and Sarndal et al. (1992, ch. 3.5):
the take-all stratum contributes zero variance (it is a census)
and does not inflate the degrees of freedom for the probability
stratum.

For stages using with-replacement methods (\code{srswr},
\code{pps_multinomial}), the finite population correction is omitted
and the \code{.draw_k} column (sequential draw index) is used as the
sampling unit identifier for Hansen-Hurwitz variance estimation.

The \code{survey} package is required but not imported -- it must be
installed to use this function.
}
}
\examples{
\dontshow{if (requireNamespace("survey", quietly = TRUE)) withAutoprint(\{ # examplesIf}
# Stratified sample -> survey design
sample <- sampling_design() |>
  stratify_by(facility_type, alloc = "proportional") |>
  draw(n = 300) |>
  execute(kenya_health, seed = 42)

svy <- as_svydesign(sample)
survey::svymean(~beds, svy)

# Two-stage cluster sample with PPS first stage
sample <- sampling_design() |>
  add_stage() |>
    stratify_by(region) |>
    cluster_by(ea_id) |>
    draw(n = 5, method = "pps_brewer", mos = hh_count) |>
  add_stage() |>
    draw(n = 12) |>
  execute(niger_eas, seed = 2025)

# Default: Brewer variance approximation
svy <- as_svydesign(sample)

# Exact: compute joint probabilities from frame
jip <- joint_expectation(sample, niger_eas, stage = 1)
svy_exact <- as_svydesign(sample, pps = survey::ppsmat(jip[[1]]))
\dontshow{\}) # examplesIf}
}
\references{
Berger, Y.G. (2004). A Simple Variance Estimator for Unequal
Probability Sampling Without Replacement. \emph{Journal of Applied
Statistics}, 31, 305-315.

Brewer, K.R.W. (2002). \emph{Combined Survey Sampling Inference
(Weighing Basu's Elephants)}. Chapter 9.

Chauvet, G. (2019). Properties of Chromy's sampling procedure.
\emph{arXiv:1912.10896}.

Chromy, J.R. (2009). Some Generalizations of the Horvitz-Thompson
Estimator. \emph{JSM Proceedings, Survey Research Methods Section}.

Cochran, W.G. (1977). \emph{Sampling Techniques}. 3rd edition. Wiley.

Sarndal, C.-E., Swensson, B. and Wretman, J. (1992). \emph{Model
Assisted Survey Sampling}. Springer.
}
\seealso{
\code{\link[=execute]{execute()}} for producing tbl_sample objects,
\code{\link[survey:svydesign]{survey::svydesign()}} for the underlying function,
\link{as_survey_design.tbl_sample} for converting directly to a srvyr \code{tbl_svy},
\code{as_svrepdesign()} for replicate-weight export
}
